#!/bin/bash

# ============================================
# kurbeScript - Kubernetes Cluster Setup
# ============================================
# ALX Backend Python - Messaging App Assignment
# ============================================

echo "========================================"
echo "Kubernetes Cluster Setup"
echo "========================================"

# Function to print colored output
print_green() { echo -e "\033[0;32m$1\033[0m"; }
print_red() { echo -e "\033[0;31m$1\033[0m"; }
print_yellow() { echo -e "\033[1;33m$1\033[0m"; }

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# --------------------------------------------------
# 1. ENSURE MINIKUBE IS INSTALLED
# --------------------------------------------------
print_yellow "1. Checking Minikube installation..."
if command_exists minikube; then
    print_green "   ✓ Minikube is installed"
    echo "   Version: $(minikube version --short 2>/dev/null || echo 'unknown')"
else
    print_red "   ✗ Minikube is NOT installed"
    echo "   Installing Minikube..."
    
    # Try to install minikube
    if command_exists curl; then
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube 2>/dev/null || {
            mkdir -p ~/.local/bin
            install minikube-linux-amd64 ~/.local/bin/minikube
            export PATH="$HOME/.local/bin:$PATH"
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
        }
        rm minikube-linux-amd64
        
        if command_exists minikube; then
            print_green "   ✓ Minikube installed successfully"
        else
            print_red "   ✗ Minikube installation failed"
            echo "   Please install manually: https://minikube.sigs.k8s.io"
            exit 1
        fi
    else
        print_red "   ✗ curl not available to download minikube"
        exit 1
    fi
fi

# --------------------------------------------------
# 2. ENSURE KUBECTL IS INSTALLED
# --------------------------------------------------
print_yellow ""
print_yellow "2. Checking kubectl installation..."
if command_exists kubectl; then
    print_green "   ✓ kubectl is installed"
else
    print_red "   ✗ kubectl is NOT installed"
    echo "   Installing kubectl..."
    
    if command_exists curl; then
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install kubectl /usr/local/bin/kubectl 2>/dev/null || {
            mkdir -p ~/.local/bin
            install kubectl ~/.local/bin/kubectl
            chmod +x ~/.local/bin/kubectl
            export PATH="$HOME/.local/bin:$PATH"
        }
        rm kubectl
        
        if command_exists kubectl; then
            print_green "   ✓ kubectl installed successfully"
        else
            print_red "   ✗ kubectl installation failed"
        fi
    fi
fi

# --------------------------------------------------
# 3. START KUBERNETES CLUSTER
# --------------------------------------------------
print_yellow ""
print_yellow "3. Starting Kubernetes cluster..."

# Check if cluster is already running
if minikube status 2>/dev/null | grep -q "Running"; then
    print_green "   ✓ Cluster is already running"
else
    echo "   Starting Minikube cluster..."
    
    # Try different drivers
    if minikube start --driver=docker 2>/dev/null; then
        print_green "   ✓ Cluster started with docker driver"
    elif minikube start --driver=virtualbox 2>/dev/null; then
        print_green "   ✓ Cluster started with virtualbox driver"
    elif minikube start --driver=none 2>/dev/null; then
        print_green "   ✓ Cluster started with none driver"
    else
        print_red "   ✗ Failed to start cluster"
        echo "   Please check: minikube start --driver=docker"
        # Don't exit - continue to show what we have
    fi
fi

# --------------------------------------------------
# 4. VERIFY CLUSTER IS RUNNING
# --------------------------------------------------
print_yellow ""
print_yellow "4. Verifying cluster with kubectl cluster-info..."
if kubectl cluster-info 2>/dev/null; then
    print_green "   ✓ Cluster verification successful"
else
    print_red "   ✗ Could not verify cluster"
    echo "   Trying alternative verification..."
    
    # Try other verification methods
    if kubectl get nodes 2>/dev/null; then
        print_green "   ✓ Nodes are accessible"
    else
        print_red "   ✗ Cannot connect to cluster"
    fi
fi

# --------------------------------------------------
# 5. RETRIEVE AVAILABLE PODS
# --------------------------------------------------
print_yellow ""
print_yellow "5. Retrieving available pods..."
echo "   Pods in all namespaces:"
kubectl get pods --all-namespaces 2>/dev/null || {
    echo "   Could not retrieve pods"
    echo "   This might be normal if cluster is still starting"
    
    # Wait and try again
    echo "   Waiting 10 seconds and trying again..."
    sleep 10
    kubectl get pods --all-namespaces 2>/dev/null || echo "   Still no pods available"
}

# --------------------------------------------------
# 6. FINAL STATUS
# --------------------------------------------------
echo ""
print_green "========================================"
print_green "SETUP COMPLETED"
print_green "========================================"
echo ""
echo "Summary:"
echo "  Minikube: $(command_exists minikube && echo "Installed" || echo "Not installed")"
echo "  kubectl: $(command_exists kubectl && echo "Installed" || echo "Not installed")"
echo "  Cluster: $(minikube status 2>/dev/null | grep -q "Running" && echo "Running" || echo "Not running")"
echo ""
echo "To stop cluster: minikube stop"
echo "To delete cluster: minikube delete"
echo "To view dashboard: minikube dashboard"
