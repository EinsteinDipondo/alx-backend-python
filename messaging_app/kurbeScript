#!/bin/bash

# ============================================
# Kubernetes Local Cluster Setup Script
# ============================================
# Author: ALX Backend Python
# Description: Sets up a local Kubernetes cluster using Minikube
# ============================================

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}"
    echo "========================================="
    echo "  Kubernetes Local Cluster Setup Script  "
    echo "========================================="
    echo -e "${NC}"
}

print_footer() {
    echo -e "${BLUE}"
    echo "========================================="
    echo "  Setup Complete!                        "
    echo "========================================="
    echo -e "${NC}"
}

# ============================================
# Function: Check prerequisites
# ============================================
check_prerequisites() {
    log_info "Checking system prerequisites..."
    
    # Check if running as root/with sudo
    if [ "$EUID" -eq 0 ]; then 
        log_warning "Running as root. Some operations might require user context."
    fi
    
    # Check OS
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        log_info "Detected OS: $NAME $VERSION"
    fi
    
    # Check virtualization support
    log_info "Checking virtualization support..."
    if grep -E --color 'vmx|svm' /proc/cpuinfo > /dev/null; then
        log_success "Virtualization is enabled in BIOS"
    else
        log_warning "Virtualization might not be enabled. Some features may not work."
    fi
    
    # Check memory
    total_mem=$(free -g | awk '/^Mem:/{print $2}')
    if [ "$total_mem" -lt 2 ]; then
        log_warning "System has less than 2GB RAM. Minikube might be slow."
    else
        log_success "System has ${total_mem}GB RAM"
    fi
    
    # Check disk space
    disk_space=$(df -h / | awk 'NR==2 {print $4}')
    log_info "Available disk space: $disk_space"
}

# ============================================
# Function: Install Minikube
# ============================================
install_minikube() {
    log_info "Checking if Minikube is installed..."
    
    if command -v minikube &> /dev/null; then
        minikube_version=$(minikube version --short)
        log_success "Minikube is already installed: $minikube_version"
        return 0
    fi
    
    log_info "Minikube not found. Installing..."
    
    # Download Minikube binary
    log_info "Downloading Minikube..."
    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
         || { log_error "Failed to download Minikube"; exit 1; }
    
    # Install Minikube
    log_info "Installing Minikube to /usr/local/bin..."
    sudo install minikube-linux-amd64 /usr/local/bin/minikube \
         || { log_error "Failed to install Minikube"; exit 1; }
    
    # Clean up
    rm minikube-linux-amd64
    
    # Verify installation
    if command -v minikube &> /dev/null; then
        log_success "Minikube installed successfully"
        minikube version --short
    else
        log_error "Minikube installation failed"
        exit 1
    fi
}

# ============================================
# Function: Install kubectl
# ============================================
install_kubectl() {
    log_info "Checking if kubectl is installed..."
    
    if command -v kubectl &> /dev/null; then
        kubectl_version=$(kubectl version --client --short | awk '{print $3}')
        log_success "kubectl is already installed: $kubectl_version"
        return 0
    fi
    
    log_info "kubectl not found. Installing..."
    
    # Download kubectl
    log_info "Downloading kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
         || { log_error "Failed to download kubectl"; exit 1; }
    
    # Install kubectl
    log_info "Installing kubectl to /usr/local/bin..."
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl \
         || { log_error "Failed to install kubectl"; exit 1; }
    
    # Clean up
    rm kubectl
    
    # Verify installation
    if command -v kubectl &> /dev/null; then
        log_success "kubectl installed successfully"
        kubectl version --client --short
    else
        log_error "kubectl installation failed"
        exit 1
    fi
}

# ============================================
# Function: Check and install Docker
# ============================================
check_docker() {
    log_info "Checking if Docker is available..."
    
    if command -v docker &> /dev/null; then
        docker_version=$(docker --version | awk '{print $3}')
        log_success "Docker is available: $docker_version"
        
        # Check if user is in docker group
        if groups $USER | grep -q '\bdocker\b'; then
            log_success "User is in docker group"
        else
            log_warning "User is not in docker group. Adding to docker group..."
            sudo usermod -aG docker $USER
            log_info "Please log out and log back in for changes to take effect"
        fi
        return 0
    fi
    
    log_warning "Docker not found. Minikube can use other drivers, but Docker is recommended."
    log_info "To install Docker, run: curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh"
    
    read -p "Do you want to install Docker now? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Installing Docker..."
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo usermod -aG docker $USER
        log_success "Docker installed. Please log out and log back in."
    fi
}

# ============================================
# Function: Start Kubernetes cluster
# ============================================
start_cluster() {
    log_info "Starting Kubernetes cluster..."
    
    # Check if cluster is already running
    if minikube status 2>/dev/null | grep -q "Running"; then
        log_success "Kubernetes cluster is already running"
        return 0
    fi
    
    # Choose driver based on what's available
    if command -v docker &> /dev/null && systemctl is-active --quiet docker 2>/dev/null; then
        DRIVER="docker"
        log_info "Using Docker driver"
    elif command -v podman &> /dev/null; then
        DRIVER="podman"
        log_info "Using Podman driver"
    else
        DRIVER="virtualbox"
        log_info "Using VirtualBox driver (will prompt for installation if needed)"
    fi
    
    # Start Minikube cluster
    log_info "Starting Minikube with $DRIVER driver..."
    
    if [ "$DRIVER" = "docker" ]; then
        # Ensure Docker daemon is running
        if ! systemctl is-active --quiet docker 2>/dev/null; then
            log_info "Starting Docker daemon..."
            sudo systemctl start docker || log_warning "Could not start Docker"
        fi
    fi
    
    # Start the cluster with optimal settings
    minikube start --driver=$DRIVER \
        --memory=4096 \
        --cpus=2 \
        --disk-size=20g \
        --addons=ingress \
        --addons=dashboard \
        --addons=metrics-server \
        --extra-config=kubelet.housekeeping-interval=10s
    
    if [ $? -eq 0 ]; then
        log_success "Kubernetes cluster started successfully"
    else
        log_error "Failed to start Kubernetes cluster"
        log_info "Trying alternative configuration..."
        
        # Try with minimal configuration
        minikube start --driver=$DRIVER --memory=2048 --cpus=2
        
        if [ $? -ne 0 ]; then
            log_error "Cluster startup failed. Please check the logs with: minikube logs"
            exit 1
        fi
    fi
}

# ============================================
# Function: Verify cluster status
# ============================================
verify_cluster() {
    log_info "Verifying cluster status..."
    
    # Get cluster info
    log_info "Cluster information:"
    kubectl cluster-info
    
    # Check if cluster info command succeeded
    if [ $? -eq 0 ]; then
        log_success "Cluster is running and accessible"
    else
        log_error "Cannot connect to cluster"
        exit 1
    fi
    
    # Show cluster details
    log_info "Cluster details:"
    kubectl get componentstatuses
    echo ""
    
    # Show nodes
    log_info "Cluster nodes:"
    kubectl get nodes -o wide
    echo ""
}

# ============================================
# Function: Retrieve available pods
# ============================================
get_pods() {
    log_info "Retrieving available pods..."
    
    # Get pods in all namespaces
    log_info "Pods in all namespaces:"
    kubectl get pods --all-namespaces
    
    echo ""
    
    # Get pods in default namespace with more details
    log_info "Detailed pod information (default namespace):"
    kubectl get pods -o wide
    
    # Show pod counts
    echo ""
    log_info "Pod summary:"
    kubectl get pods --all-namespaces --no-headers | wc -l | \
        xargs echo "Total pods across all namespaces: "
    
    # Check system pods
    echo ""
    log_info "System pods (kube-system namespace):"
    kubectl get pods -n kube-system
}

# ============================================
# Function: Set up local environment
# ============================================
setup_environment() {
    log_info "Setting up local environment..."
    
    # Set kubectl context
    kubectl config use-context minikube
    
    # Set Docker environment if using Docker driver
    if minikube config get driver 2>/dev/null | grep -q docker; then
        log_info "Setting Docker environment variables for Minikube..."
        eval $(minikube docker-env 2>/dev/null) || log_warning "Could not set Docker environment"
    fi
    
    # Create alias for convenience
    echo ""
    log_info "Useful commands:"
    echo "  kubectl get all                         # Get all resources"
    echo "  minikube dashboard                      # Open Kubernetes dashboard"
    echo "  minikube service list                   # List all services"
    echo "  kubectl get events --sort-by='.lastTimestamp'  # View recent events"
}

# ============================================
# Function: Run diagnostics
# ============================================
run_diagnostics() {
    log_info "Running cluster diagnostics..."
    
    echo ""
    log_info "1. Checking cluster health:"
    minikube status
    
    echo ""
    log_info "2. Checking addons:"
    minikube addons list
    
    echo ""
    log_info "3. Checking service status:"
    kubectl get svc --all-namespaces
    
    echo ""
    log_info "4. Checking deployment status:"
    kubectl get deployments --all-namespaces
    
    echo ""
    log_info "5. Checking storage classes:"
    kubectl get storageclass
    
    echo ""
    log_info "6. Checking events (last 10):"
    kubectl get events --sort-by='.lastTimestamp' | tail -10
}

# ============================================
# Main execution flow
# ============================================
main() {
    print_header
    
    log_info "Starting Kubernetes local cluster setup..."
    echo ""
    
    # Step 1: Check prerequisites
    check_prerequisites
    echo ""
    
    # Step 2: Install kubectl
    install_kubectl
    echo ""
    
    # Step 3: Check Docker (optional but recommended)
    check_docker
    echo ""
    
    # Step 4: Install Minikube
    install_minikube
    echo ""
    
    # Step 5: Start the cluster
    start_cluster
    echo ""
    
    # Step 6: Verify cluster
    verify_cluster
    echo ""
    
    # Step 7: Get pods
    get_pods
    echo ""
    
    # Step 8: Setup environment
    setup_environment
    echo ""
    
    # Step 9: Run diagnostics
    run_diagnostics
    echo ""
    
    # Final instructions
    log_success "Kubernetes local cluster setup completed successfully!"
    echo ""
    
    log_info "Next steps:"
    echo "  1. Try deploying a sample app: kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.4"
    echo "  2. Expose the deployment: kubectl expose deployment hello-minikube --type=NodePort --port=8080"
    echo "  3. Access the dashboard: minikube dashboard"
    echo "  4. Check tutorial: minikube tutorial"
    echo ""
    
    log_info "To stop the cluster: minikube stop"
    log_info "To delete the cluster: minikube delete"
    log_info "To start the cluster again: minikube start"
    
    print_footer
}

# ============================================
# Cleanup function for interruptions
# ============================================
cleanup() {
    log_warning "Script interrupted. Cleaning up..."
    log_info "Current cluster status:"
    minikube status 2>/dev/null || true
    exit 1
}

# Set trap for interrupt signals
trap cleanup INT TERM

# Run main function
main

exit 0
